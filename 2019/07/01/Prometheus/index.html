<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">



<title>Prometheus+Grafana监控实践 | Hexo</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">陈欣宇&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">陈欣宇&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Prometheus+Grafana监控实践</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">陈欣宇</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2019-07-01&nbsp;&nbsp;00:00:00</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h4 id="什么是Prometheus"><a href="#什么是Prometheus" class="headerlink" title="什么是Prometheus"></a>什么是Prometheus</h4><blockquote>
<p>Prometheus 是由 SoundCloud 开源监控告警解决方案，从 2012 年开始编写代码，再到 2015 年 github 上开源以来，已经吸引了 9k+ 关注，以及很多大公司的使用；2016 年 Prometheus 成为继 k8s 后，第二名 CNCF(Cloud Native Computing Foundation) 成员。</p>
</blockquote>
<p>作为新一代开源解决方案，很多理念与 Google SRE 运维之道不谋而合。</p>
<h4 id="为什么选择prometheus："><a href="#为什么选择prometheus：" class="headerlink" title="为什么选择prometheus："></a>为什么选择prometheus：</h4><ul>
<li>Prometheus 是按照 Google SRE 运维之道的理念构建的，具有实用性和前瞻性。</li>
<li>Prometheus 社区非常活跃，基本稳定在 1个月1个版本的迭代速度，从 2016 年 v1.01 开始接触使用以来，到目前发布的 v1.8.2 以及最新最新的 v2.1 ，你会发现 Prometheus 一直在进步、在优化。</li>
<li>Go 语言开发，性能不错，安装部署简单，多平台部署兼容性好。</li>
<li>丰富的数据收集客户端，官方提供了各种常用 exporter。</li>
<li>丰富强大的查询能力,内置更强大的统计函数。</li>
<li>Prometheus 属于一站式监控告警平台，依赖少，功能齐全。</li>
<li>Prometheus支持对云或容器的监控，其他监控系统主要对主机监控。</li>
</ul>
<a id="more"></a>
<p>Prometheus 在数据存储扩展性以及持久性上没有 InfluxDB，OpenTSDB，Sensu 好。</p>
<h4 id="安装prometheus"><a href="#安装prometheus" class="headerlink" title="安装prometheus"></a>安装prometheus</h4><ol>
<li><p>下载二进制包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在这个页面https://prometheus.io/download</span><br><span class="line">找到最新的二进制包</span><br><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.7.2/prometheus-2.7.2.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>解压并进入对应文件夹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar xvfz prometheus-*.tar.gz</span><br><span class="line">cd prometheus-*</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动prometheus</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./prometheus --config.file=prometheus.yml</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>grafana dashboard<br>主机基础监控 dashboard id 9276</p>
<h5 id="此时，prometheus-服务已在后台运行，注意暴露的端口号-9090（address-0-0-0-0-9090），可以直接在浏览器打开-ip-9090-查看简易控制台，此控制台可以做调试使用，需要更强大、美观的数据展示官方建议使用-Grafana"><a href="#此时，prometheus-服务已在后台运行，注意暴露的端口号-9090（address-0-0-0-0-9090），可以直接在浏览器打开-ip-9090-查看简易控制台，此控制台可以做调试使用，需要更强大、美观的数据展示官方建议使用-Grafana" class="headerlink" title="此时，prometheus 服务已在后台运行，注意暴露的端口号 9090（address=0.0.0.0:9090），可以直接在浏览器打开 ip:9090 查看简易控制台，此控制台可以做调试使用，需要更强大、美观的数据展示官方建议使用 Grafana."></a>此时，prometheus 服务已在后台运行，注意暴露的端口号 9090（address=0.0.0.0:9090），可以直接在浏览器打开 ip:9090 查看简易控制台，此控制台可以做调试使用，需要更强大、美观的数据展示官方建议使用 Grafana.</h5><hr>
<h4 id="安装-grafana"><a href="#安装-grafana" class="headerlink" title="安装 grafana"></a>安装 grafana</h4><p>（数据展示<a href="https://grafana.com" target="_blank" rel="noopener">https://grafana.com</a>）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana-5.0.2-1.x86_64.rpm</span><br><span class="line"></span><br><span class="line">yum  localinstall grafana-5.0.2-1.x86_64.rpm</span><br><span class="line"></span><br><span class="line">service grafana-server start</span><br></pre></td></tr></table></figure>

<p>此时，grafana 服务已经启动，可以直接在浏览器中打开 localhost:3000 开始体验 grafana 了</p>
<hr>
<h4 id="exporter"><a href="#exporter" class="headerlink" title="exporter"></a>exporter</h4><p>Prometheus官网有很多exporter，exporter可以理解为<strong>采集客户端</strong>，即采集指标，通过http方式暴露metrics给prometheus，Prometheus通过pull方式拉取这些指标。</p>
<ol>
<li>node_exporter（linux 系统信息采集器）</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/node_exporter/releases/download/v0.18.0/node_exporter-0.18.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">tar -zxvf node_exporter-0.18.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">cd node_exporter-0.18.0.linux-amd64</span><br><span class="line"></span><br><span class="line">nohup ./node_exporter &amp; （在后台运行系统信息采集器）</span><br></pre></td></tr></table></figure>

<p> 可以通过curl查看<br> curl 127.0.0.1:9100/metrics</p>
<blockquote>
<p>Tips：0.16.0 版本在 centos 6.x 运行时报错 kernel too old，下载 0.15.2 或之前版本即可<br><a href="https://github.com/prometheus/node_exporter/releases/download/v0.15.2/node_exporter-0.15.2.linux-amd64.tar.gz" target="_blank" rel="noopener">https://github.com/prometheus/node_exporter/releases/download/v0.15.2/node_exporter-0.15.2.linux-amd64.tar.gz</a></p>
</blockquote>
<p>此时，系统信息采集器已在后台运行，等待 prometheus 服务来拉取数据，注意暴露的端口号 9100（msg=”Listening on :9100”），prometheus 拉取数据需要使用此端口号</p>
<h4 id="安装-prometheus"><a href="#安装-prometheus" class="headerlink" title="安装 prometheus"></a>安装 prometheus</h4><p>prometheus <a href="https://prometheus.io/" target="_blank" rel="noopener">https://prometheus.io/</a>）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.2.1/prometheus-2.2.1.linux-amd64.tar.gz</span><br><span class="line">tar -zxvf prometheus-2.2.1.linux-amd64.tar.gz</span><br><span class="line">cd prometheus-2.2.1.linux-amd64</span><br></pre></td></tr></table></figure>

<p>vi prometheus.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  scrape_interval: 10s</span><br><span class="line">  evaluation_interval: 10s</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: prometheus</span><br><span class="line">    scrape_interval: 10s</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&apos;localhost:9090&apos;]</span><br><span class="line">        labels:</span><br><span class="line">          instance: prometheus</span><br><span class="line"></span><br><span class="line">  - job_name: mysql</span><br><span class="line">    scrape_interval: 10s</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&apos;localhost:9104&apos;]</span><br><span class="line">        labels:</span><br><span class="line">          instance: mysql</span><br><span class="line"></span><br><span class="line">  - job_name: &apos;linux&apos;</span><br><span class="line">    scrape_interval: 10s</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&apos;localhost:9100&apos;]</span><br><span class="line">        labels:</span><br><span class="line">          instance: linux</span><br></pre></td></tr></table></figure>

<h5 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h5><p>nohup ./prometheus –config.file=”prometheus.yml” &amp;（在后台运行 prometheus 服务）</p>
<h4 id="Prometheus配置的热加载"><a href="#Prometheus配置的热加载" class="headerlink" title="Prometheus配置的热加载"></a>Prometheus配置的热加载</h4><p>Prometheus配置信息的热加载有两种方式：</p>
<ul>
<li><p>第一种热加载方式：查看Prometheus的进程id，发送SIGHUP信号:<br>kill -HUP <pid></pid></p>
</li>
<li><p>第二种热加载方式：发送一个POST请求到/-/reload，需要在启动时给定–web.enable-lifecycle选项：<br>curl -X POST <a href="http://localhost:9090/-/reload" target="_blank" rel="noopener">http://localhost:9090/-/reload</a></p>
</li>
</ul>
<p>我们使用的是第一种热加载方式，systemd unit文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=prometheus</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">ExecStart=/usr/local/prometheus/prometheus \</span><br><span class="line"> --config.file=/usr/local/prometheus/prometheus.yml \</span><br><span class="line"> --storage.tsdb.path=/home/prometheus/data \</span><br><span class="line"> --storage.tsdb.retention=365d \</span><br><span class="line"> --web.listen-address=:9090 \</span><br><span class="line"> --web.external-url=https://prometheus.frognew.com</span><br><span class="line">ExecReload=/bin/kill -HUP $MAINPID</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>systemctl reload prometheus</p>
<h4 id="告警服务-Alertmanager"><a href="#告警服务-Alertmanager" class="headerlink" title="告警服务 Alertmanager"></a>告警服务 Alertmanager</h4><p>告警能力在Prometheus的架构中被划分成两个独立的部分。如下所示，通过在Prometheus中定义AlertRule（告警规则），Prometheus会周期性的对告警规则进行计算，如果满足告警触发条件就会向Alertmanager发送告警信息。<br><img src="evernotecid://94C76643-58DA-4407-AFA8-9F2A33EF0AAA/appyinxiangcom/11651347/ENResource/p3081" alt="2957ddc2799240dd958cbdf9bf4a46f7.png"></p>
<h4 id="一些问题"><a href="#一些问题" class="headerlink" title="一些问题"></a>一些问题</h4><ol>
<li>为什么选择 pull  而不是push<br>通过HTTP提供了许多优势：</li>
</ol>
<ul>
<li>您可以在开发更改时在笔记本电脑上运行监控。</li>
<li>您可以更轻松地判断目标是否已关闭。</li>
<li>您可以手动转到目标并使用Web浏览器检查其运行状况。<br>总体而言，我们认为拉动比推动略好，但在考虑监控系统时，不应将其视为重点。</li>
</ul>
<p>附录:<br>线上 Prometheus 配置文件 prometheus.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># my global config</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     30s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 30s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line"></span><br><span class="line"># Alertmanager configuration</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">       - alertmanager:9093</span><br><span class="line"></span><br><span class="line"># Load rules once and periodically evaluate them according to the global &apos;evaluation_interval&apos;.</span><br><span class="line">rule_files:</span><br><span class="line">   - &quot;/etc/prometheus/rules/*.rules&quot;</span><br><span class="line">  # - &quot;second_rules.yml&quot;</span><br><span class="line"></span><br><span class="line"># A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line"># Here it&apos;s Prometheus itself.</span><br><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span><br><span class="line">  - job_name: &apos;prometheus&apos;</span><br><span class="line"></span><br><span class="line">    # metrics_path defaults to &apos;/metrics&apos;</span><br><span class="line">    # scheme defaults to &apos;http&apos;.</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&apos;localhost:9090&apos;]</span><br><span class="line"></span><br><span class="line">  - job_name: &apos;telegraf&apos;</span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files: [&apos;./*.json&apos;]</span><br><span class="line"></span><br><span class="line">remote_write:</span><br><span class="line">  - url: &quot;http://influxdb:8086/api/v1/prom/write?db=prometheus&quot;</span><br><span class="line"></span><br><span class="line">remote_read:</span><br><span class="line">  - url: &quot;http://influxdb:8086/api/v1/prom/read?db=prometheus&quot;</span><br></pre></td></tr></table></figure>


        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>陈欣宇</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://hichenxinyu.github.io/2019/07/01/Prometheus/">http://hichenxinyu.github.io/2019/07/01/Prometheus/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/Prometheus/"># Prometheus</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2019/09/13/Ansible/">Ansible</a>
            
            
            <a class="next" rel="next" href="/2019/01/14/VScode使用笔记/">VScode使用笔记</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© 陈欣宇 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
