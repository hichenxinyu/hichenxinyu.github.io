<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=author content="Covey.Liu"><link rel=prev href=https://example.com/2019/prometheus/><link rel=next href=https://example.com/2019/kafka-zookeeper%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/><link rel=canonical href=https://example.com/2019/redis-%E6%8C%81%E4%B9%85%E5%8C%96/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>Redis 持久化 | LeaveIt</title><meta name=title content="Redis 持久化 | LeaveIt"><link rel=stylesheet href=/font/iconfont.css><link rel=stylesheet href=/css/main.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/example.com"},"articleSection":"posts","name":"Redis 持久化","headline":"Redis 持久化","description":"Redis的读写性能俱佳，但由于是内存数据库，如果没有提前备份，Redis数据是掉电即失的。 Redis提供了两种方式进行持久化：\n RDB持久化 AOF持久化  原理 将Redis在内存中的数据定时dump到磁盘上，实际操作过程是fork一个子进程，先将数据写入临时文件，写入成功后，再替换之前的文件，用二进制压缩存储 打印rdb文件\nroot@pa6:\/var\/lib\/redis# od -c dump.rdb 0000000 R E D I S 0 0 0 6 376 \\0 \\0 003 k e y 0000020 301 177 # 377 ] } 362 366 313 362 n 020 0000034 AOF 持久化存储 AOF持久化：将Redis的操作日志以文件追加的方式写入文件，只记录写、删除操作，查询操作不会记录（类似于MySQL的Binlog日志）\n因为BGSAVE命令可以在不阻塞服务器进程的情况下执行，所以Redis允许用户通过设置服务器配置的save选项，让服务器每隔一段时间自动执行一次BGSAVE命令 用户可以通过save选项设置多个保存条件，但只要其中任意一个条件被满足，服务器就会执行BGSAVE命令 举个例子，如果我们向服务器提供以下配置 vim redis.conf\nsave 900 1 save 300 10 save 60 10000 那么只要满足以下三个条件中的任意一个，BGSAVE命令就会被执行 服务器在900秒之内，对数据库进行了至少1次修改 服务器在300秒之内，对数据库进行了至少10次修改 服务器在60秒之内，对数据库进行了至少10000次修改。\n备份脚本 #!\/bin\/bash # 避免造成雪崩 set -e # bak 目录 BACKUPDIR=\/data\/redis\/backup #PASSWD=\x27redis密码\x27 #DATADIR=`\/usr\/local\/bin\/redis-cli -p 端口 -a \x26quot;$PASSWD\x26quot; config get dir|grep -Ev \x27dir|grep\x27` # 获取redis-cli 二进制文件 REDIS_CMD=$(which redis-cli) DATADIR=`$REDIS_CMD config get dir|grep -Ev \x27dir|grep\x27` DATE=`date \x2b\x27%Y-%m-%d-%H-%M\x27` BACKUPDIR_DATE=$BACKUPDIR_$DATE if [ !","inLanguage":"en-us","author":"Covey.Liu","creator":"Covey.Liu","publisher":"Covey.Liu","accountablePerson":"Covey.Liu","copyrightHolder":"Covey.Liu","copyrightYear":"2019","datePublished":"2019-07-11 00:00:00 \x2b0000 UTC","dateModified":"2019-07-11 00:00:00 \x2b0000 UTC","url":"https:\/\/example.com\/2019\/redis-%E6%8C%81%E4%B9%85%E5%8C%96\/","wordCount":"131","keywords":["LeaveIt"]}</script></head><body><div class=wrapper><nav class=navbar><div class=container><div class="navbar-header header-logo"><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href=https://example.com>LeaveIt</a></div><div class="menu navbar-right"><a class=menu-item href=/posts/>Blog</a>
<a class=menu-item href=/categories/>Categories</a>
<a class=menu-item href=/tags/>Tags</a>
<a class=menu-item href=/about/>About</a></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><div class=container><div class=navbar-header><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href=https://example.com>LeaveIt</a></div><div class=menu-toggle><span></span><span></span><span></span></div></div><div class=menu id=mobile-menu><a class=menu-item href=/posts/>Blog</a>
<a class=menu-item href=/categories/>Categories</a>
<a class=menu-item href=/tags/>Tags</a>
<a class=menu-item href=/about/>About</a></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">Redis 持久化</h1><div class=post-meta>Written by <a itemprop=name href=https://example.com rel=author>Covey.Liu</a> with ♥
<span class=post-time>on <time datetime=2019-07-11 itemprop=datePublished>July 11, 2019</time></span>
in</div></header><div class=post-content><p>Redis的读写性能俱佳，但由于是内存数据库，如果没有提前备份，Redis数据是掉电即失的。
Redis提供了两种方式进行持久化：</p><ol><li>RDB持久化</li><li>AOF持久化</li></ol><h3 id=heading>原理</h3><p>将Redis在内存中的数据定时<code>dump</code>到磁盘上，实际操作过程是<code>fork</code>一个子进程，先将数据写入临时文件，写入成功后，再替换之前的文件，用二进制压缩存储
打印rdb文件</p><pre><code>root@pa6:/var/lib/redis# od -c dump.rdb
0000000   R   E   D   I   S   0   0   0   6 376  \0  \0 003   k   e   y
0000020 301 177   # 377   ]   } 362 366 313 362   n 020
0000034
</code></pre><p><img src=https://blog-pic-1253367462.cos.ap-shanghai.myqcloud.com/1567665181186-fcf56c20-aed6-4cb4-b55b-edeff6d6c3a3.png alt=image.png></p><h4 id=aof->AOF 持久化存储</h4><p>AOF持久化：将Redis的操作日志以文件追加的方式写入文件，只记录写、删除操作，查询操作不会记录（类似于MySQL的Binlog日志）</p><p><img src=https://blog-pic-1253367462.cos.ap-shanghai.myqcloud.com/1567665214953-264e7ec5-2993-431b-9e38-6ccfd3206f57.png alt=image.png></p><p>因为BGSAVE命令可以在不阻塞服务器进程的情况下执行，所以Redis允许用户通过设置服务器配置的save选项，让服务器每隔一段时间自动执行一次BGSAVE命令
用户可以通过save选项设置多个保存条件，但只要其中任意一个条件被满足，服务器就会执行BGSAVE命令 举个例子，如果我们向服务器提供以下配置
vim redis.conf</p><pre><code>save 900 1
save 300 10
save 60 10000
</code></pre><p>那么只要满足以下三个条件中的任意一个，BGSAVE命令就会被执行 服务器在900秒之内，对数据库进行了至少1次修改
服务器在300秒之内，对数据库进行了至少10次修改
服务器在60秒之内，对数据库进行了至少10000次修改。</p><h4 id=heading-1>备份脚本</h4><pre><code>#!/bin/bash
# 避免造成雪崩
set -e
# bak 目录
BACKUPDIR=/data/redis/backup
#PASSWD='redis密码'
#DATADIR=`/usr/local/bin/redis-cli -p 端口 -a &quot;$PASSWD&quot; config get dir|grep -Ev 'dir|grep'`
# 获取redis-cli 二进制文件
REDIS_CMD=$(which redis-cli)
DATADIR=`$REDIS_CMD  config get dir|grep -Ev 'dir|grep'`
DATE=`date +'%Y-%m-%d-%H-%M'`
BACKUPDIR_DATE=$BACKUPDIR_$DATE

if [ ! -d $BACKUPDIR ];then
        mkdir -p $BACKUPDIR \
        || echo &quot;can't make dir !!!&quot; \
        &amp;&amp; exit 1
fi
#以日期分类
mkdir -p $BACKUPDIR/$BACKUPDIR_DATE
$REDIS_CMD  bgsave
sleep 3
cp -rf $DATADIR/* $BACKUPDIR/$BACKUPDIR_DATE
</code></pre></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>Covey.Liu</span></p><p class=copyright-item><span>Link:</span>
<a href=https://example.com/2019/redis-%E6%8C%81%E4%B9%85%E5%8C%96/>https://example.com/2019/redis-%E6%8C%81%E4%B9%85%E5%8C%96/</span></p><p class="copyright-item lincese">本文采用<a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/ target=_blank>知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p></div><div class=post-tags><section><a href=javascript:window.history.back();>back</a></span> ·
<span><a href=https://example.com>home</a></span></section></div><div class=post-nav><a href=https://example.com/2019/prometheus/ class=prev rel=prev title=Prometheus+Grafana监控实践><i class="iconfont icon-left"></i>&nbsp;Prometheus+Grafana监控实践</a>
<a href=https://example.com/2019/kafka-zookeeper%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/ class=next rel=next title="Kafka & ZooKeeper 集群搭建">Kafka & ZooKeeper 集群搭建&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2011 - 2020</span>
<span class=with-love><i class="iconfont icon-love"></i></span><span class=author itemprop=copyrightHolder><a href=https://example.com>Covey.Liu</a> |</span>
<span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow">Hugo</a> & <a href=https://github.com/liuzc/leaveit target=_blank rel="external nofollow">LeaveIt</a></span></div></footer><link href=//lib.baomitu.com/lightgallery/1.6.11/css/lightgallery.min.css rel=stylesheet><script src=/js/vendor_gallery.min.js async></script></div></body></html>